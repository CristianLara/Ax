<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ax.core.batch_trial &mdash; Ax 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../_static/documentation_options.js?v=3ff7b324"></script>
        <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex/" />
    <link rel="search" title="Search" href="../../../../search/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../" class="icon icon-home">
            Ax
          </a>
              <div class="version">
                0.0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../ax/">ax</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../benchmark/">ax.benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../core/">ax.core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../exceptions/">ax.exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../metrics/">ax.metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modelbridge/">ax.modelbridge</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../models/">ax.models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../plot/">ax.plot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../runners/">ax.runners</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../service/">ax.service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../storage/">ax.storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../telemetry/">ax.telemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../utils/">ax.utils</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../">Ax</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../">Module code</a></li>
      <li class="breadcrumb-item active">ax.core.batch_trial</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ax.core.batch_trial</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># Copyright (c) Meta Platforms, Inc. and affiliates.</span>
<span class="c1">#</span>
<span class="c1"># This source code is licensed under the MIT license found in the</span>
<span class="c1"># LICENSE file in the root directory of this source tree.</span>

<span class="c1"># pyre-strict</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">MutableMapping</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">logging</span> <span class="kn">import</span> <span class="n">Logger</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">ax.core.arm</span> <span class="kn">import</span> <span class="n">Arm</span>
<span class="kn">from</span> <span class="nn">ax.core.base_trial</span> <span class="kn">import</span> <span class="n">BaseTrial</span>
<span class="kn">from</span> <span class="nn">ax.core.data</span> <span class="kn">import</span> <span class="n">Data</span>
<span class="kn">from</span> <span class="nn">ax.core.generator_run</span> <span class="kn">import</span> <span class="n">ArmWeight</span><span class="p">,</span> <span class="n">GeneratorRun</span><span class="p">,</span> <span class="n">GeneratorRunType</span>
<span class="kn">from</span> <span class="nn">ax.core.trial</span> <span class="kn">import</span> <span class="n">immutable_once_run</span>
<span class="kn">from</span> <span class="nn">ax.core.types</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">TCandidateMetadata</span><span class="p">,</span>
    <span class="n">TEvaluationOutcome</span><span class="p">,</span>
    <span class="n">validate_evaluation_outcome</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">ax.exceptions.core</span> <span class="kn">import</span> <span class="n">AxError</span><span class="p">,</span> <span class="n">UnsupportedError</span><span class="p">,</span> <span class="n">UserInputError</span>
<span class="kn">from</span> <span class="nn">ax.utils.common.base</span> <span class="kn">import</span> <span class="n">SortableBase</span>
<span class="kn">from</span> <span class="nn">ax.utils.common.docutils</span> <span class="kn">import</span> <span class="n">copy_doc</span>
<span class="kn">from</span> <span class="nn">ax.utils.common.equality</span> <span class="kn">import</span> <span class="n">datetime_equals</span><span class="p">,</span> <span class="n">equality_typechecker</span>
<span class="kn">from</span> <span class="nn">ax.utils.common.logger</span> <span class="kn">import</span> <span class="n">_round_floats_for_logging</span><span class="p">,</span> <span class="n">get_logger</span>
<span class="kn">from</span> <span class="nn">ax.utils.common.typeutils</span> <span class="kn">import</span> <span class="n">checked_cast</span><span class="p">,</span> <span class="n">not_none</span>

<span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="c1"># import as module to make sphinx-autodoc-typehints happy</span>
    <span class="kn">from</span> <span class="nn">ax</span> <span class="kn">import</span> <span class="n">core</span>  <span class="c1"># noqa F401</span>

<span class="n">BATCH_TRIAL_RAW_DATA_FORMAT_ERROR_MESSAGE</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;Raw data must be a dict for batched trials.&quot;</span>
<span class="p">)</span>


<div class="viewcode-block" id="LifecycleStage">
<a class="viewcode-back" href="../../../../core/#ax.core.batch_trial.LifecycleStage">[docs]</a>
<span class="k">class</span> <span class="nc">LifecycleStage</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
    <span class="n">EXPLORATION</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ITERATION</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">BAKEOFF</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">OFFLINE_OPTIMIZED</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">EXPLORATION_CONCURRENT</span> <span class="o">=</span> <span class="mi">4</span></div>



<div class="viewcode-block" id="AbandonedArm">
<a class="viewcode-back" href="../../../../core/#ax.core.batch_trial.AbandonedArm">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">AbandonedArm</span><span class="p">(</span><span class="n">SortableBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class storing metadata of arm that has been abandoned within</span>
<span class="sd">    a BatchTrial.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">time</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">reason</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@equality_typechecker</span>
    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">AbandonedArm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">reason</span>
            <span class="ow">and</span> <span class="n">datetime_equals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_unique_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span></div>



<div class="viewcode-block" id="GeneratorRunStruct">
<a class="viewcode-back" href="../../../../core/#ax.core.batch_trial.GeneratorRunStruct">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">GeneratorRunStruct</span><span class="p">(</span><span class="n">SortableBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stores GeneratorRun object as well as the weight with which it was added.&quot;&quot;&quot;</span>

    <span class="n">generator_run</span><span class="p">:</span> <span class="n">GeneratorRun</span>
    <span class="n">weight</span><span class="p">:</span> <span class="nb">float</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_unique_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator_run</span><span class="o">.</span><span class="n">_unique_id</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span></div>



<div class="viewcode-block" id="BatchTrial">
<a class="viewcode-back" href="../../../../core/#ax.core.batch_trial.BatchTrial">[docs]</a>
<span class="k">class</span> <span class="nc">BatchTrial</span><span class="p">(</span><span class="n">BaseTrial</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Batched trial that has multiple attached arms, meant to be</span>
<span class="sd">    *deployed and evaluated together*, and possibly arm weights, which are</span>
<span class="sd">    a measure of how much of the total resources allocated to evaluating</span>
<span class="sd">    a batch should go towards evaluating the specific arm. For instance,</span>
<span class="sd">    for field experiments the weights could describe the fraction of the</span>
<span class="sd">    total experiment population assigned to the different treatment arms.</span>
<span class="sd">    Interpretation of the weights is defined in Runner.</span>

<span class="sd">    NOTE: A `BatchTrial` is not just a trial with many arms; it is a trial,</span>
<span class="sd">    for which it is important that the arms are evaluated simultaneously, e.g.</span>
<span class="sd">    in an A/B test where the evaluation results are subject to nonstationarity.</span>
<span class="sd">    For cases where multiple arms are evaluated separately and independently of</span>
<span class="sd">    each other, use multiple `Trial` objects with a single arm each.</span>

<span class="sd">    Args:</span>
<span class="sd">        experiment: Experiment, to which this trial is attached</span>
<span class="sd">        generator_run: GeneratorRun, associated with this trial. This can a</span>
<span class="sd">            also be set later through `add_arm` or `add_generator_run`, but a</span>
<span class="sd">            trial&#39;s associated generator run is immutable once set.</span>
<span class="sd">        generator_runs: GeneratorRuns, associated with this trial. This can a</span>
<span class="sd">            also be set later through `add_arm` or `add_generator_run`, but a</span>
<span class="sd">            trial&#39;s associated generator run is immutable once set.  This cannot</span>
<span class="sd">            be combined with the `generator_run` argument.</span>
<span class="sd">        trial_type: Type of this trial, if used in MultiTypeExperiment.</span>
<span class="sd">        optimize_for_power: Whether to optimize the weights of arms in this</span>
<span class="sd">            trial such that the experiment&#39;s power to detect effects of</span>
<span class="sd">            certain size is as high as possible. Refer to documentation of</span>
<span class="sd">            `BatchTrial.set_status_quo_and_optimize_power` for more detail.</span>
<span class="sd">        ttl_seconds: If specified, trials will be considered failed after</span>
<span class="sd">            this many seconds since the time the trial was ran, unless the</span>
<span class="sd">            trial is completed before then. Meant to be used to detect</span>
<span class="sd">            &#39;dead&#39; trials, for which the evaluation process might have</span>
<span class="sd">            crashed etc., and which should be considered failed after</span>
<span class="sd">            their &#39;time to live&#39; has passed.</span>
<span class="sd">        index: If specified, the trial&#39;s index will be set accordingly.</span>
<span class="sd">            This should generally not be specified, as in the index will be</span>
<span class="sd">            automatically determined based on the number of existing trials.</span>
<span class="sd">            This is only used for the purpose of loading from storage.</span>
<span class="sd">        lifecycle_stage: The stage of the experiment lifecycle that this</span>
<span class="sd">            trial represents</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">experiment</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">Experiment</span><span class="p">,</span>
        <span class="n">generator_run</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GeneratorRun</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">generator_runs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">GeneratorRun</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">trial_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">optimize_for_power</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ttl_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">lifecycle_stage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LifecycleStage</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span>
            <span class="n">trial_type</span><span class="o">=</span><span class="n">trial_type</span><span class="p">,</span>
            <span class="n">ttl_seconds</span><span class="o">=</span><span class="n">ttl_seconds</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arms_by_name</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Arm</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generator_run_structs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">GeneratorRunStruct</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_abandoned_arms_metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AbandonedArm</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_quo</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Arm</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_quo_weight_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">generator_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">generator_runs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UnsupportedError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot specify both `generator_run` and `generator_runs`.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_generator_run</span><span class="p">(</span><span class="n">generator_run</span><span class="o">=</span><span class="n">generator_run</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">generator_runs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">gr</span> <span class="ow">in</span> <span class="n">generator_runs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_generator_run</span><span class="p">(</span><span class="n">generator_run</span><span class="o">=</span><span class="n">gr</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">optimize_for_power</span> <span class="o">=</span> <span class="n">optimize_for_power</span>
        <span class="n">status_quo</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">status_quo</span>
        <span class="k">if</span> <span class="n">optimize_for_power</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">status_quo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Can only optimize for power if experiment has a status quo.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_status_quo_and_optimize_power</span><span class="p">(</span><span class="n">status_quo</span><span class="o">=</span><span class="n">status_quo</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Set the status quo for tracking purposes</span>
            <span class="c1"># It will not be included in arm_weights</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status_quo</span> <span class="o">=</span> <span class="n">status_quo</span>

        <span class="c1"># Trial status quos are stored in the DB as a generator run</span>
        <span class="c1"># with one arm; thus we need to store two `db_id` values</span>
        <span class="c1"># for this object instead of one</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_quo_generator_run_db_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_quo_arm_db_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lifecycle_stage</span> <span class="o">=</span> <span class="n">lifecycle_stage</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">Experiment</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The experiment this batch belongs to.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_experiment</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The index of this batch within the experiment&#39;s batch list.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">generator_run_structs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">GeneratorRunStruct</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of generator run structs attached to this trial.</span>

<span class="sd">        Struct holds generator_run object and the weight with which it was added.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generator_run_structs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">arm_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="n">Arm</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The set of arms and associated weights for the trial.</span>

<span class="sd">        These are constructed by merging the arms and weights from</span>
<span class="sd">        each generator run that is attached to the trial.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">arm_weights</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generator_run_structs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_quo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">arm_weights</span>
        <span class="k">for</span> <span class="n">struct</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generator_run_structs</span><span class="p">:</span>
            <span class="n">multiplier</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">weight</span>
            <span class="k">for</span> <span class="n">arm</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">generator_run</span><span class="o">.</span><span class="n">arm_weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">scaled_weight</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">multiplier</span>
                <span class="k">if</span> <span class="n">arm</span> <span class="ow">in</span> <span class="n">arm_weights</span><span class="p">:</span>
                    <span class="n">arm_weights</span><span class="p">[</span><span class="n">arm</span><span class="p">]</span> <span class="o">+=</span> <span class="n">scaled_weight</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">arm_weights</span><span class="p">[</span><span class="n">arm</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaled_weight</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_quo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_quo_weight_override</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If override is specified, this is the weight the status quo gets,</span>
            <span class="c1"># regardless of whether it appeared in any generator runs.</span>
            <span class="c1"># If no override is specified, status quo does not appear in arm_weights.</span>
            <span class="n">arm_weights</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">status_quo</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_quo_weight_override</span>
        <span class="k">return</span> <span class="n">arm_weights</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lifecycle_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LifecycleStage</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lifecycle_stage</span>

    <span class="nd">@arm_weights</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">arm_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arm_weights</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="n">Arm</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Use `trial.add_arms_and_weights`&quot;</span><span class="p">)</span>

    <span class="nd">@immutable_once_run</span>
    <span class="k">def</span> <span class="nf">add_arm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arm</span><span class="p">:</span> <span class="n">Arm</span><span class="p">,</span> <span class="n">weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BatchTrial</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a arm to the trial.</span>

<span class="sd">        Args:</span>
<span class="sd">            arm: The arm to be added.</span>
<span class="sd">            weight: The weight with which this arm should be added.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The trial instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_arms_and_weights</span><span class="p">(</span><span class="n">arms</span><span class="o">=</span><span class="p">[</span><span class="n">arm</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="n">weight</span><span class="p">])</span>

    <span class="nd">@immutable_once_run</span>
    <span class="k">def</span> <span class="nf">add_arms_and_weights</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">arms</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Arm</span><span class="p">],</span>
        <span class="n">weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">multiplier</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BatchTrial</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add arms and weights to the trial.</span>

<span class="sd">        Args:</span>
<span class="sd">            arms: The arms to be added.</span>
<span class="sd">            weights: The weights associated with the arms.</span>
<span class="sd">            multiplier: The multiplier applied to input weights before merging with</span>
<span class="sd">                the current set of arms and weights.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The trial instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_generator_run</span><span class="p">(</span>
            <span class="n">generator_run</span><span class="o">=</span><span class="n">GeneratorRun</span><span class="p">(</span>
                <span class="n">arms</span><span class="o">=</span><span class="n">arms</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">GeneratorRunType</span><span class="o">.</span><span class="n">MANUAL</span><span class="o">.</span><span class="n">name</span>
            <span class="p">),</span>
            <span class="n">multiplier</span><span class="o">=</span><span class="n">multiplier</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@immutable_once_run</span>
    <span class="k">def</span> <span class="nf">add_generator_run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">generator_run</span><span class="p">:</span> <span class="n">GeneratorRun</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BatchTrial</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a generator run to the trial.</span>

<span class="sd">        The arms and weights from the generator run will be merged with</span>
<span class="sd">        the existing arms and weights on the trial, and the generator run</span>
<span class="sd">        object will be linked to the trial for tracking.</span>

<span class="sd">        Args:</span>
<span class="sd">            generator_run: The generator run to be added.</span>
<span class="sd">            multiplier: The multiplier applied to input weights before merging with</span>
<span class="sd">                the current set of arms and weights.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The trial instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First validate generator run arms</span>
        <span class="k">for</span> <span class="n">arm</span> <span class="ow">in</span> <span class="n">generator_run</span><span class="o">.</span><span class="n">arms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">search_space</span><span class="o">.</span><span class="n">check_types</span><span class="p">(</span><span class="n">arm</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">raise_error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Clone arms to avoid mutating existing state</span>
        <span class="n">generator_run</span><span class="o">.</span><span class="n">_arm_weight_table</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="n">arm_sig</span><span class="p">:</span> <span class="n">ArmWeight</span><span class="p">(</span><span class="n">arm_weight</span><span class="o">.</span><span class="n">arm</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="n">arm_weight</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">arm_sig</span><span class="p">,</span> <span class="n">arm_weight</span> <span class="ow">in</span> <span class="n">generator_run</span><span class="o">.</span><span class="n">_arm_weight_table</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Add names to arms</span>
        <span class="c1"># For those not yet added to this experiment, create a new name</span>
        <span class="c1"># Else, use the name of the existing arm</span>
        <span class="k">for</span> <span class="n">arm</span> <span class="ow">in</span> <span class="n">generator_run</span><span class="o">.</span><span class="n">arms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_existing_and_name_arm</span><span class="p">(</span><span class="n">arm</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_generator_run_structs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">GeneratorRunStruct</span><span class="p">(</span><span class="n">generator_run</span><span class="o">=</span><span class="n">generator_run</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">multiplier</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">generator_run</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generator_run_structs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_quo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize_for_power</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_status_quo_and_optimize_power</span><span class="p">(</span><span class="n">status_quo</span><span class="o">=</span><span class="n">not_none</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_quo</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">generator_run</span><span class="o">.</span><span class="n">_generation_step_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_generation_step_index</span><span class="p">(</span>
                <span class="n">generation_step_index</span><span class="o">=</span><span class="n">generator_run</span><span class="o">.</span><span class="n">_generation_step_index</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_arms_by_name</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">status_quo</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Arm</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The control arm for this batch.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_quo</span>

    <span class="nd">@status_quo</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">status_quo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_quo</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Arm</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Use `set_status_quo_with_weight` or &quot;</span>
            <span class="s2">&quot;`set_status_quo_and_optimize_power` &quot;</span>
            <span class="s2">&quot;to set the status quo arm.&quot;</span>
        <span class="p">)</span>

<div class="viewcode-block" id="BatchTrial.unset_status_quo">
<a class="viewcode-back" href="../../../../core/#ax.core.batch_trial.BatchTrial.unset_status_quo">[docs]</a>
    <span class="k">def</span> <span class="nf">unset_status_quo</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the status quo to None.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_quo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_quo_weight_override</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_arms_by_name</span><span class="p">()</span></div>


    <span class="nd">@immutable_once_run</span>
    <span class="k">def</span> <span class="nf">set_status_quo_with_weight</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">status_quo</span><span class="p">:</span> <span class="n">Arm</span><span class="p">,</span> <span class="n">weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BatchTrial</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets status quo arm with given weight. This weight *overrides* any</span>
<span class="sd">        weight the status quo has from generator runs attached to this batch.</span>
<span class="sd">        Thus, this function is not the same as using add_arm, which will</span>
<span class="sd">        result in the weight being additive over all generator runs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Assign a name to this arm if none exists</span>
        <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">weight</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Status quo weight must be positive.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">status_quo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot set weight because status quo is not defined.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status_quo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">search_space</span><span class="o">.</span><span class="n">check_types</span><span class="p">(</span>
                <span class="n">status_quo</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">raise_error</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">_name_and_store_arm_if_not_exists</span><span class="p">(</span>
                <span class="n">arm</span><span class="o">=</span><span class="n">status_quo</span><span class="p">,</span>
                <span class="n">proposed_name</span><span class="o">=</span><span class="s2">&quot;status_quo_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
                <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_quo</span> <span class="o">=</span> <span class="n">status_quo</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">if</span> <span class="n">status_quo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_quo_weight_override</span> <span class="o">=</span> <span class="n">weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_arms_by_name</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@immutable_once_run</span>
    <span class="k">def</span> <span class="nf">set_status_quo_and_optimize_power</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_quo</span><span class="p">:</span> <span class="n">Arm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BatchTrial</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds a status quo arm to the batch and optimizes for power.</span>

<span class="sd">        NOTE: this optimization based on the arms that are currently attached</span>
<span class="sd">        to the batch. If you add more arms later, you should re-run this function.</span>
<span class="sd">        If you want the optimization to happen automatically,</span>
<span class="sd">        set batch.optimize_for_power = True.</span>

<span class="sd">        This function will maximize power across the multiple pair-wise</span>
<span class="sd">        comparisons of existing arms against the status_quo.</span>

<span class="sd">        Specifically, this function assigns sqrt(sum_weights) weight to the</span>
<span class="sd">        status quo, where sum_weights is the sum of the weights of the existing</span>
<span class="sd">        arms, excluding the status quo. This will be optimal in terms of</span>
<span class="sd">        statistical power in the case where:</span>
<span class="sd">            1) status quo is the only arm to compare against,</span>
<span class="sd">            2) all other arms are of equal interest.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">status_quo_is_only_arm</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_quo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">status_quo_is_only_arm</span><span class="p">:</span>
            <span class="c1"># If status quo is the only arm, just set its weight to 1</span>
            <span class="c1"># Can&#39;t use logic below, because it will choose 0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_status_quo_with_weight</span><span class="p">(</span><span class="n">status_quo</span><span class="o">=</span><span class="n">status_quo</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># arm_weights should always have at least one arm now</span>
        <span class="n">arm_weights</span> <span class="o">=</span> <span class="n">not_none</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arm_weights</span><span class="p">)</span>
        <span class="n">sum_weights</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">w</span> <span class="k">for</span> <span class="n">arm</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">arm_weights</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">arm</span> <span class="o">!=</span> <span class="n">status_quo</span><span class="p">)</span>
        <span class="n">optimal_status_quo_weight_override</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sum_weights</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_status_quo_with_weight</span><span class="p">(</span>
            <span class="n">status_quo</span><span class="o">=</span><span class="n">status_quo</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">optimal_status_quo_weight_override</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">arms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Arm</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;All arms contained in the trial.&quot;&quot;&quot;</span>
        <span class="n">arm_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arm_weights</span>
        <span class="k">return</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">arm_weights</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">arm_weights</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weights</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Weights corresponding to arms contained in the trial.&quot;&quot;&quot;</span>
        <span class="n">arm_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arm_weights</span>
        <span class="k">return</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">arm_weights</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">arm_weights</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">arms_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Arm</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Map from arm name to object for all arms in trial.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arms_by_name</span>

    <span class="k">def</span> <span class="nf">_refresh_arms_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arms_by_name</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">arm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arms</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">arm</span><span class="o">.</span><span class="n">has_name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Arms attached to a trial must have a name.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arms_by_name</span><span class="p">[</span><span class="n">arm</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">arm</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">abandoned_arms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Arm</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of arms that have been abandoned within this trial.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">arms_by_name</span><span class="p">[</span><span class="n">arm</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">arm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_abandoned_arms_metadata</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">abandoned_arm_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set of names of arms that have been abandoned within this trial.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_abandoned_arms_metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">in_design_arms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Arm</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">arm</span>
            <span class="k">for</span> <span class="n">arm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arms</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">search_space</span><span class="o">.</span><span class="n">check_membership</span><span class="p">(</span><span class="n">arm</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="c1"># pyre-ignore[6]: T77111662.</span>
    <span class="nd">@copy_doc</span><span class="p">(</span><span class="n">BaseTrial</span><span class="o">.</span><span class="n">generator_runs</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">generator_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">GeneratorRun</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">grs</span><span class="o">.</span><span class="n">generator_run</span> <span class="k">for</span> <span class="n">grs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator_run_structs</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">abandoned_arms_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">AbandonedArm</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_abandoned_arms_metadata</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_factorial</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return true if the trial&#39;s arms are a factorial design with</span>
<span class="sd">        no linked factors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># To match the model behavior, this should probably actually be pulled</span>
        <span class="c1"># from exp.parameters. However, that seems rather ugly when this function</span>
        <span class="c1"># intuitively should just depend on the arms.</span>
        <span class="n">sufficient_factors</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arm</span><span class="o">.</span><span class="n">parameters</span> <span class="ow">or</span> <span class="p">[])</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">arm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arms</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sufficient_factors</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">param_levels</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arms</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param_value</span> <span class="ow">in</span> <span class="n">arm</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">param_levels</span><span class="p">[</span><span class="n">param_name</span><span class="p">][</span><span class="n">not_none</span><span class="p">(</span><span class="n">param_value</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">param_cardinality</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">param_values</span> <span class="ow">in</span> <span class="n">param_levels</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">param_cardinality</span> <span class="o">*=</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_values</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arms</span><span class="p">)</span> <span class="o">==</span> <span class="n">param_cardinality</span>

<div class="viewcode-block" id="BatchTrial.run">
<a class="viewcode-back" href="../../../../core/#ax.core.batch_trial.BatchTrial.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BatchTrial</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">checked_cast</span><span class="p">(</span><span class="n">BatchTrial</span><span class="p">,</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">())</span></div>


<div class="viewcode-block" id="BatchTrial.normalized_arm_weights">
<a class="viewcode-back" href="../../../../core/#ax.core.batch_trial.BatchTrial.normalized_arm_weights">[docs]</a>
    <span class="k">def</span> <span class="nf">normalized_arm_weights</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">total</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">trunc_digits</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="n">Arm</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns arms with a new set of weights normalized</span>
<span class="sd">        to the given total.</span>

<span class="sd">        This method is useful for many runners where we need to normalize weights</span>
<span class="sd">        to a certain total without mutating the weights attached to a trial.</span>

<span class="sd">        Args:</span>
<span class="sd">            total: The total weight to which to normalize.</span>
<span class="sd">                Default is 1, in which case arm weights</span>
<span class="sd">                can be interpreted as probabilities.</span>
<span class="sd">            trunc_digits: The number of digits to keep. If the</span>
<span class="sd">                resulting total weight is not equal to `total`, re-allocate</span>
<span class="sd">                weight in such a way to maintain relative weights as best as</span>
<span class="sd">                possible.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Mapping from arms to the new set of weights.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trunc_digits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">atomic_weight</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**-</span><span class="n">trunc_digits</span>
            <span class="c1"># pyre-fixme[16]: `float` has no attribute `astype`.</span>
            <span class="n">int_weights</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">total</span> <span class="o">/</span> <span class="n">atomic_weight</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">weights</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">n_leftover</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">total</span> <span class="o">/</span> <span class="n">atomic_weight</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">int_weights</span><span class="p">)</span>
            <span class="n">int_weights</span><span class="p">[:</span><span class="n">n_leftover</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">int_weights</span> <span class="o">*</span> <span class="n">atomic_weight</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">*</span> <span class="p">(</span><span class="n">total</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arms</span><span class="p">,</span> <span class="n">weights</span><span class="p">))</span></div>


<div class="viewcode-block" id="BatchTrial.mark_arm_abandoned">
<a class="viewcode-back" href="../../../../core/#ax.core.batch_trial.BatchTrial.mark_arm_abandoned">[docs]</a>
    <span class="k">def</span> <span class="nf">mark_arm_abandoned</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">arm_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BatchTrial</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mark a arm abandoned.</span>

<span class="sd">        Usually done after deployment when one arm causes issues but</span>
<span class="sd">        user wants to continue running other arms in the batch.</span>

<span class="sd">        NOTE: Abandoned arms are considered to be &#39;pending points&#39; in</span>
<span class="sd">        experiment after their abandonment to avoid Ax models suggesting</span>
<span class="sd">        the same arm again as a new candidate. Abandoned arms are also</span>
<span class="sd">        excluded from model training data unless ``fit_abandoned``</span>
<span class="sd">        option is specified to model bridge.</span>

<span class="sd">        Args:</span>
<span class="sd">            arm_name: The name of the arm to abandon.</span>
<span class="sd">            reason: The reason for abandoning the arm.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The batch instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">arm_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arms_by_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Arm must be contained in batch.&quot;</span><span class="p">)</span>

        <span class="n">abandoned_arm</span> <span class="o">=</span> <span class="n">AbandonedArm</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">arm_name</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_abandoned_arms_metadata</span><span class="p">[</span><span class="n">arm_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">abandoned_arm</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="BatchTrial.clone">
<a class="viewcode-back" href="../../../../core/#ax.core.batch_trial.BatchTrial.clone">[docs]</a>
    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BatchTrial</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clone the trial and attach it to the current experiment.&quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;clone() method is getting deprecated. Please use clone_to() instead.&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone_to</span><span class="p">(</span><span class="n">include_sq</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="BatchTrial.clone_to">
<a class="viewcode-back" href="../../../../core/#ax.core.batch_trial.BatchTrial.clone_to">[docs]</a>
    <span class="k">def</span> <span class="nf">clone_to</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">experiment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">core</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">Experiment</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_sq</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BatchTrial</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clone the trial and attach it to a specified experiment.</span>
<span class="sd">        If None provided, attach it to the current experiment.</span>

<span class="sd">        Args:</span>
<span class="sd">            experiment: The experiment to which the cloned trial will belong.</span>
<span class="sd">                If unspecified, uses the current experiment.</span>
<span class="sd">            include_sq: Whether to include status quo in the cloned trial.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A new instance of the trial.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">use_old_experiment</span> <span class="o">=</span> <span class="n">experiment</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="n">experiment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_experiment</span> <span class="k">if</span> <span class="n">experiment</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">experiment</span>
        <span class="n">new_trial</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">new_batch_trial</span><span class="p">(</span>
            <span class="n">trial_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_trial_type</span><span class="p">,</span> <span class="n">ttl_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ttl_seconds</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">struct</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generator_run_structs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_old_experiment</span><span class="p">:</span>
                <span class="c1"># don&#39;t clone gen run in case we are attaching cloned trial to</span>
                <span class="c1"># the same experiment</span>
                <span class="n">new_trial</span><span class="o">.</span><span class="n">add_generator_run</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">generator_run</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_trial</span><span class="o">.</span><span class="n">add_generator_run</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">generator_run</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="n">struct</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_status_quo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">include_sq</span><span class="p">:</span>
            <span class="n">sq_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_quo_weight_override</span>
            <span class="n">new_trial</span><span class="o">.</span><span class="n">set_status_quo_with_weight</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_status_quo</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span>
                <span class="n">weight</span><span class="o">=</span><span class="n">sq_weight</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_trial_attrs_on_clone</span><span class="p">(</span><span class="n">new_trial</span><span class="o">=</span><span class="n">new_trial</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_trial</span></div>


<div class="viewcode-block" id="BatchTrial.attach_batch_trial_data">
<a class="viewcode-back" href="../../../../core/#ax.core.batch_trial.BatchTrial.attach_batch_trial_data">[docs]</a>
    <span class="k">def</span> <span class="nf">attach_batch_trial_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">raw_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TEvaluationOutcome</span><span class="p">],</span>
        <span class="n">sample_sizes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attaches data to the trial</span>

<span class="sd">        Args:</span>
<span class="sd">            raw_data: Map from arm name to metric outcomes.</span>
<span class="sd">            sample_sizes: Dict from arm name to sample size.</span>
<span class="sd">            metadata: Additional metadata to track about this run.</span>
<span class="sd">                importantly the start_date and end_date</span>
<span class="sd">            complete_trial: Whether to mark trial as complete after</span>
<span class="sd">                attaching data. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate type of raw_data</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">BATCH_TRIAL_RAW_DATA_FORMAT_ERROR_MESSAGE</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">BATCH_TRIAL_RAW_DATA_FORMAT_ERROR_MESSAGE</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">validate_evaluation_outcome</span><span class="p">(</span><span class="n">outcome</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">BATCH_TRIAL_RAW_DATA_FORMAT_ERROR_MESSAGE</span><span class="p">)</span>

        <span class="c1"># Format the data to save.</span>
        <span class="n">not_trial_arm_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">raw_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arms_by_name</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">not_trial_arm_names</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserInputError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Arms </span><span class="si">{</span><span class="n">not_trial_arm_names</span><span class="si">}</span><span class="s2"> are not part of trial #</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="n">evaluations</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_evaluations_and_data</span><span class="p">(</span>
            <span class="n">raw_data</span><span class="o">=</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">sample_sizes</span><span class="o">=</span><span class="n">sample_sizes</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_batch_trial_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_run_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_metadata</span> <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">attach_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">data_for_logging</span> <span class="o">=</span> <span class="n">_round_floats_for_logging</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">evaluations</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Updated trial </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2"> with data: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_round_floats_for_logging</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">data_for_logging</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;BatchTrial(&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;experiment_name=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_experiment</span><span class="o">.</span><span class="n">_name</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;index=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;status=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_candidate_metadata_from_all_generator_runs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TCandidateMetadata</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves combined candidate metadata from all generator runs on this</span>
<span class="sd">        batch trial in the form of { arm name -&gt; candidate metadata} mapping.</span>

<span class="sd">        NOTE: this does not handle the case of the same arm appearing in multiple</span>
<span class="sd">        generator runs in the same trial: metadata from only one of the generator</span>
<span class="sd">        runs containing the arm will be retrieved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cand_metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">gr_struct</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generator_run_structs</span><span class="p">:</span>
            <span class="n">gr</span> <span class="o">=</span> <span class="n">gr_struct</span><span class="o">.</span><span class="n">generator_run</span>
            <span class="k">if</span> <span class="n">gr</span><span class="o">.</span><span class="n">candidate_metadata_by_arm_signature</span><span class="p">:</span>
                <span class="n">gr_cand_metadata</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">candidate_metadata_by_arm_signature</span>
                <span class="n">warn</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">arm</span> <span class="ow">in</span> <span class="n">gr</span><span class="o">.</span><span class="n">arms</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">arm</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">cand_metadata</span><span class="p">:</span>
                        <span class="n">warn</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">gr_cand_metadata</span><span class="p">:</span>
                        <span class="c1"># Reformat the mapping to be by arm name, since arm signature</span>
                        <span class="c1"># is not stored in Ax data.</span>
                        <span class="n">cand_metadata</span><span class="p">[</span><span class="n">arm</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gr_cand_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">arm</span><span class="o">.</span><span class="n">signature</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;The same arm appears in multiple generator runs in batch &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">. Candidate metadata will only contain metadata &quot;</span>
                        <span class="s2">&quot;for one of those generator runs, and the candidate metadata &quot;</span>
                        <span class="s2">&quot;for the arm from another generator run will not be propagated.&quot;</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">cand_metadata</span>

    <span class="k">def</span> <span class="nf">_get_candidate_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arm_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TCandidateMetadata</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves candidate metadata for a specific arm.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">arm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arms_by_name</span><span class="p">[</span><span class="n">arm_name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Arm by name </span><span class="si">{</span><span class="n">arm_name</span><span class="si">}</span><span class="s2"> is not part of trial #</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">gr_struct</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generator_run_structs</span><span class="p">:</span>
            <span class="n">gr</span> <span class="o">=</span> <span class="n">gr_struct</span><span class="o">.</span><span class="n">generator_run</span>
            <span class="k">if</span> <span class="n">gr</span> <span class="ow">and</span> <span class="n">gr</span><span class="o">.</span><span class="n">candidate_metadata_by_arm_signature</span> <span class="ow">and</span> <span class="n">arm</span> <span class="ow">in</span> <span class="n">gr</span><span class="o">.</span><span class="n">arms</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">not_none</span><span class="p">(</span><span class="n">gr</span><span class="o">.</span><span class="n">candidate_metadata_by_arm_signature</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">arm</span><span class="o">.</span><span class="n">signature</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_validate_batch_trial_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Utility function to validate batch data before further processing.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_quo</span>
            <span class="ow">and</span> <span class="n">not_none</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_quo</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arms_by_name</span>
            <span class="ow">and</span> <span class="n">not_none</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_quo</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;arm_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">AxError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Trial #</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2"> was completed with data that did &quot;</span>
                <span class="s2">&quot;not contain status quo observations, but the trial has &quot;</span>
                <span class="s2">&quot;status quo set and therefore data for it is required.&quot;</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;metric_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Data was logged for metric </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> that was not yet &quot;</span>
                    <span class="s2">&quot;tracked on the experiment. Please specify `tracking_metric_&quot;</span>
                    <span class="s2">&quot;names` argument in AxClient.create_experiment to add tracking &quot;</span>
                    <span class="s2">&quot;metrics to the experiment. Without those, all data users &quot;</span>
                    <span class="s2">&quot;specify is still attached to the experiment, but will not be &quot;</span>
                    <span class="s2">&quot;fetched in `experiment.fetch_data()`, but you can still use &quot;</span>
                    <span class="s2">&quot;`experiment.lookup_data_for_trial` to get all attached data.&quot;</span>
                <span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>